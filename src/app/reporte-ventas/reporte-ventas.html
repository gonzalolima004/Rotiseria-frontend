
<section class="reporte container py-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h1 class="h4 m-0 text-dark fw-bold">Reporte de Ventas - En La Rotonda</h1>
    <div class="d-flex align-items-end gap-2 filtros">
      <div class="d-flex flex-column">
        <label class="form-label small text-muted mb-1">Desde</label>
        <input type="date" class="form-control form-control-sm"
               [value]="desde()" (change)="desde.set($any($event.target).value)" />
      </div>
      <div class="d-flex flex-column">
        <label class="form-label small text-muted mb-1">Hasta</label>
        <input type="date" class="form-control form-control-sm"
               [value]="hasta()" (change)="hasta.set($any($event.target).value)" />
      </div>
      <button class="btn btn-primary btn-sm fw-semibold" (click)="load()">
        Refrescar
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 kpis-row mb-3">
    <div class="col-12 col-md-4">
      <div class="card kpi-card shadow-sm border-2 rounded-3">
        <div class="card-body">
          <div class="kpi-label">Ventas Hoy</div>
          <div class="kpi-value">{{ money(kpiHoy()) }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card kpi-card shadow-sm border-2 rounded-3">
        <div class="card-body">
          <div class="kpi-label">Ventas Semana</div>
          <div class="kpi-value">{{ money(kpiSemana()) }}</div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card kpi-card shadow-sm border-2 rounded-3">
        <div class="card-body">
          <div class="kpi-label">Ventas Mes</div>
          <div class="kpi-value">{{ money(kpiMes()) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top boxes -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-lg-6" *ngIf="topClientes().length">
      <div class="card border-2 shadow-sm rounded-3">
        <div class="card-header bg-transparent border-0 pb-0">
          <h3 class="h6 m-0 fw-bold text-dark">Clientes usuales</h3>
        </div>
        <div class="card-body pt-3">
          <ol class="mb-0 ps-3 small">
            <li class="mb-2" *ngFor="let c of topClientes()">
              <span class="fw-semibold text-dark">{{ c.nombre }}</span>
              <span class="text-muted"> — {{ c.ventas }} ventas</span>
              <span class="badge rounded-pill ms-2 badge-soft-primary">{{ money(c.monto) }}</span>
            </li>
          </ol>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6" *ngIf="topProductos().length">
      <div class="card border-2 shadow-sm rounded-3">
        <div class="card-header bg-transparent border-0 pb-0">
          <h3 class="h6 m-0 fw-bold text-dark">Productos más vendidos</h3>
        </div>
        <div class="card-body pt-3">
          <ol class="mb-0 ps-3 small">
            <li class="mb-2" *ngFor="let p of topProductos()">
              <span class="fw-semibold text-dark">{{ p.nombre }}</span>
              <span class="badge rounded-pill ms-2 badge-soft-primary">{{ p.cantidad }} u.</span>
            </li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div *ngIf="loading()" class="alert alert-light border d-flex align-items-center gap-2">
    <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
    Cargando...
  </div>

  <div *ngIf="error() && !loading()" class="alert alert-danger">{{ error() }}</div>

  <div class="table-responsive" *ngIf="!loading() && !error()">
  <table class="table table-hover align-middle table-reporte mb-0 rounded-3">
    <thead>
      <tr>
        <th class="text-muted small fw-semibold">ID Venta</th>
        <th class="text-muted small fw-semibold">Fecha</th>
        <th class="text-muted small fw-semibold">ID Pedido</th>
        <th class="text-muted small fw-semibold">Cliente</th>
        <th class="text-muted small fw-semibold">Detalle del Pedido</th>
        <th class="text-muted small fw-semibold">Método de Pago</th>
        <th class="text-muted small fw-semibold">Modalidad</th>
        <th class="text-end text-muted small fw-semibold">Monto Total</th>
        <th class="text-end text-muted small fw-semibold"></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let f of filasFiltradas()">
        <td>{{ f.id_venta }}</td>
        <td>{{ f.fecha | date:'dd/MM/yyyy' }}</td>
        <td><span class="badge bg-light text-dark border">{{ f.id_pedido }}</span></td>
        <td class="fw-semibold">{{ f.cliente }}</td>
        <td class="text-wrap">{{ f.detalle_pedido || '-' }}</td>
        <td><span class="badge badge-soft-primary">{{ f.metodo_pago }}</span></td>
        <td><span class="badge badge-soft-muted">{{ f.modalidad_entrega }}</span></td>
        <td class="text-end fw-bold text-money">{{ money(f.monto_total) }}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" (click)="openEdit(f)">
              <i class="bi bi-pencil-square"></i>
            </button>
            <button class="btn btn-outline-danger" (click)="openDelete(f)">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ===== Modal Editar ===== -->
<div class="modal-backdrop fade show" *ngIf="editOpen()"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="editOpen()">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0" style="background: linear-gradient(135deg, #FFCA2B 0%, #CAA021 100%);">
        <h5 class="modal-title fw-bold text-dark m-0">Editar venta</h5>
        <button class="btn-close" (click)="cancelModals()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label small text-muted">Fecha</label>
          <input type="date" class="form-control" [value]="editFecha()" (change)="editFecha.set($any($event.target).value)" />
        </div>
        <div class="mb-2">
          <label class="form-label small text-muted">Monto</label>
          <input type="number" step="0.01" class="form-control" [value]="editMonto()" (input)="editMonto.set($any($event.target).value)" />
        </div>
        <div class="mb-0">
          <label class="form-label small text-muted">ID Pedido</label>
          <input type="number" class="form-control" [value]="editIdPedido()" (input)="editIdPedido.set(($any($event.target).value))" />
        </div>
      </div>
      <div class="modal-footer border-0 bg-light">
        <button class="btn btn-outline-secondary" (click)="cancelModals()">Cancelar</button>
        <button class="btn btn-primary fw-semibold" (click)="saveEdit()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal Eliminar ===== -->
<div class="modal-backdrop fade show" *ngIf="deleteOpen()"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="deleteOpen()">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-0" style="background: linear-gradient(135deg, #FFCA2B 0%, #CAA021 100%);">
        <h5 class="modal-title fw-bold text-dark m-0">Eliminar venta</h5>
        <button class="btn-close" (click)="cancelModals()"></button>
      </div>
      <div class="modal-body">
        ¿Seguro que querés eliminar la venta
        <strong>#{{ selected()?.id_venta }}</strong>?
      </div>
      <div class="modal-footer border-0 bg-light">
        <button class="btn btn-outline-secondary" (click)="cancelModals()">Cancelar</button>
        <button class="btn btn-danger fw-semibold" (click)="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
</div>
</section>
